@model UFViewModel

<h2>UF 2024</h2>

<!-- Filtro de selección de año -->
<form method="get">
    <div class="form-row d-flex align-items-center">
        <div class="form-group col-md-3">
            <label for="selectedYear">Seleccionar Año:</label>
            <select id="selectedYear" name="selectedYear" class="form-control" style="width: auto;" onchange="this.form.submit()">
                @for (int year = 2020; year <= DateTime.Now.Year + 5; year++)
                {
                    <option value="@year" selected="@(year == DateTime.Now.Year ? "selected" : null)">@year</option>

                }
            </select>
        </div>
    </div>
</form>

<!-- Formulario para calcular UF por estudiante -->
<h3>Calcular UF por Estudiante</h3>
<form id="ufCalculatorForm" class="mt-3" onsubmit="event.preventDefault(); agregarFila();">
    <div class="form-row">
        <div class="form-group col-md-3">
            <label for="ufDate">Seleccionar Fecha:</label>
            <input type="date" id="ufDate" name="ufDate" class="form-control" required />
        </div>

        <div class="form-group col-md-3">
            <label for="valorUFEstudiante">Valor UF por Estudiante:</label>
            <input type="number" id="valorUFEstudiante" name="valorUFEstudiante" class="form-control" step="0.01" min="0" required />
        </div>

        <div class="form-group col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-success">Agregar</button>
        </div>
    </div>
</form>

<!-- Tabla de resultados -->
<h4>Resultados Calculados</h4>
<div class="table-responsive">
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Fecha solicitada</th>
                <th>Valor UF Ese Día</th>
                <th>Valor UF por Estudiante</th>
                <th>Resultado UF por Estudiante (CLP)</th>
            </tr>
        </thead>
        <tbody id="resultadosTabla">
            <!-- Las filas se agregarán aquí -->
        </tbody>
    </table>
</div>
<hr />

<!-- Tabla de UF por Meses organizada como en la imagen -->
<h3>Tabla de UF por Días y Meses</h3>
<div class="table-responsive">
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Dia</th>
                @foreach (var month in System.Globalization.CultureInfo.GetCultureInfo("es-ES").DateTimeFormat.MonthNames.Where(m => !string.IsNullOrEmpty(m)))
                {
                    <th>@month</th>
                }
            </tr>
        </thead>
        <tbody>
            @for (int day = 1; day <= 31; day++)  // Iterar sobre los días del mes
            {
                <tr>
                    <td>@day</td>  <!-- Día del mes -->
                    @foreach (var month in System.Globalization.CultureInfo.GetCultureInfo("es-ES").DateTimeFormat.MonthNames.Where(m => !string.IsNullOrEmpty(m)))
                    {
                        var ufValue = Model.UFValues.FirstOrDefault(uf => uf.Date.Day == day && uf.Date.ToString("MMMM", new System.Globalization.CultureInfo("es-ES")) == month && uf.Date.Year == Model.SelectedYear);

                        if (ufValue != null)
                        {
                            <td>@ufValue.UFValue.ToString("N2")</td>  <!-- Mostrar valor de la UF -->
                        }
                        else
                        {
                            <td>-</td>  <!-- Si no hay valor de la UF para ese día/mes -->
                        }
                    }
                </tr>
            }
        </tbody>
    </table>
</div>

<hr />
<script>
    // Función para calcular el resultado y agregar una fila a la tabla
    function agregarFila() {
        const selectedDate = document.getElementById('ufDate').value;
        const valorUFEstudiante = parseFloat(document.getElementById('valorUFEstudiante').value);

        if (!selectedDate || isNaN(valorUFEstudiante)) {
            alert("Por favor, selecciona una fecha válida y un valor UF por estudiante.");
            return;
        }

        // Buscar el valor de la UF correspondiente a la fecha seleccionada
        const ufData = @Html.Raw(Json.Serialize(Model.UFValues));
        const fechaSeleccionada = new Date(selectedDate);
        const valorUF = ufData.find(uf => new Date(uf.Date).getTime() === fechaSeleccionada.getTime());

        if (!valorUF) {
            alert("No se encontró valor de UF para la fecha seleccionada.");
            return;
        }

        const resultadoCLP = valorUFEstudiante * valorUF.UFValue;

        // Crear una nueva fila con los resultados
        const nuevaFila = `<tr>
            <td>${fechaSeleccionada.toLocaleDateString()}</td>
            <td>${valorUF.UFValue.toFixed(2)}</td>
            <td>${valorUFEstudiante.toFixed(2)}</td>
            <td>${resultadoCLP.toFixed(2)}</td>
        </tr>`;

        // Agregar la nueva fila a la tabla
        document.getElementById('resultadosTabla').innerHTML += nuevaFila;
    }
</script>
